


#include "LCD.h"
#include "i2c.h"

uint8_t lcdData = 0;
I2C_HandleTypeDef *hLcdI2C;
#define LCD_RS 0
#define LCD_RW 1
#define LCD_E  2
#define LCD_BL 3
#define LCD_4BIT_FUNC_SET 0x28
#define LCD_DISP_OFF      0x08
#define LCD_DISP_ON       0x0C
#define LCD_DISP_CLEAR    0x01
#define LCD_ENTRY_MODE_SET   0x06

#define LCD_DEV_ADDR   0x27

static void LCD_cmdMode();
static void LCD_charMode();
void LCD_WriteMode();
void LCD_E_High();
void LCD_E_Low();
void LCD_sendNibbleData(uint8_t data);
void LCD_sendData(uint8_t data);


void LCD_Init(I2C_HandleTypeDef *hI2C)
{
  hLcdI2C = hI2C;
  HAL_Delay(50);
  LCD_cmdMode();
  LCD_WriteMode();
  LCD_sendNibbleData(0x30);
  HAL_Delay(5);
  LCD_sendNibbleData(0x30);
  HAL_Delay(1);
  LCD_sendNibbleData(0x30);
  LCD_sendNibbleData(0x20);
  LCD_sendData(LCD_4BIT_FUNC_SET);
  LCD_sendData(LCD_DISP_OFF);
  LCD_sendData(LCD_DISP_CLEAR);
  LCD_sendData(LCD_ENTRY_MODE_SET);
  LCD_sendData(LCD_DISP_ON);
  LCD_backLightOn();
}

void LCD_sendI2C(uint8_t data)
{
	HAL_I2C_Master_Transmit(hLcdI2C, LCD_DEV_ADDR , &data, 1, 1000);
}

void LCD_backLightOn()
{
	lcdData |= (1<<LCD_BL);
	LCD_sendI2C(lcdData);
}

void LCD_backLightOff()
{
	lcdData &= ~(1<<LCD_BL);
	LCD_sendI2C(lcdData);
}


void LCD_cmdMode()
{
    lcdData &= ~(1<<LCD_RS);
    LCD_sendI2C(lcdData);
}

void LCD_charMode()
{
	lcdData |= (1<<LCD_RS);
	LCD_sendI2C(lcdData);
}

void LCD_WriteMode()
{
    lcdData &= ~(1<<LCD_RW);
    LCD_sendI2C(lcdData);
}


void LCD_E_High()
{
	lcdData |= (1<<LCD_E);
	LCD_sendI2C(lcdData);
}

void LCD_E_Low()
{
	lcdData &= ~(1<<LCD_E);
	LCD_sendI2C(lcdData);
}


void LCD_sendNibbleData(uint8_t data)
{
    lcdData = (lcdData & 0x0F) | (data & 0xF0);  // ✅ 먼저 데이터 설정
    LCD_sendI2C(lcdData);
    LCD_E_High();                                // ✅ 이후 E 펄스
    HAL_Delay(1);                                // 타이밍 여유 (보통 1ms 이하)
    LCD_E_Low();
}


void LCD_sendData(uint8_t data)
{
   LCD_sendNibbleData(data);

   data = data <<4;

   LCD_sendNibbleData(data);

}


void LCD_writeCmdData(uint8_t data)
{
	LCD_WriteMode();
	LCD_cmdMode();
	LCD_sendData(data);
}

void LCD_writeCharData(uint8_t data)
{
	LCD_WriteMode();
	LCD_charMode();
	LCD_sendData(data);
}


void LCD_writeString(char *str)
{
	for(int i = 0; str[i]; i++)
	{
		LCD_writeCharData(str[i]);
	}
}
