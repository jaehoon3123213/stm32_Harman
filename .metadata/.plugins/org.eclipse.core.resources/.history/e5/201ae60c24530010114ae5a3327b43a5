/*
 * HCSR04.c
 *
 *  Created on: Jun 27, 2025
 *      Author: kccistc
 */

#include "stdint.h"
#include "HCSR04.h"

static TIM_HandleTypeDef *hHCSR04Tim;
static uint32_t HCSR04TimChannel;
static GPIO_TypeDef      *HCSR04TrigPort;
static uint16_t           HCSR04TrigPin;

static uint32_t HCSR04_t1, HCSR04_t2;
static uint8_t  HCSR04_captureCnt;

void HCSR04_Init(TIM_HandleTypeDef *htim, uint32_t channel,
                 GPIO_TypeDef *trig_port, uint16_t trig_pin)
{
    hHCSR04Tim       = htim;
    HCSR04TimChannel = channel;
    HCSR04TrigPort   = trig_port;
    HCSR04TrigPin    = trig_pin;
    HCSR04_captureCnt = 0;

    // Trigger 시작이 Low
    HAL_GPIO_WritePin(HCSR04TrigPort, HCSR04TrigPin, GPIO_PIN_RESET);

    // Echo IC 시작 -> Rising edge 캡처함
    HAL_TIM_IC_Start_IT(hHCSR04Tim, HCSR04TimChannel);
}

uint32_t HCSR04_GetDistance(void)
{
    HCSR04_captureCnt = 0;

    // 10us Trigger
    HAL_GPIO_WritePin(HCSR04TrigPort, HCSR04TrigPin, GPIO_PIN_SET);
    for (volatile int i=0; i<100; i++);
    HAL_GPIO_WritePin(HCSR04TrigPort, HCSR04TrigPin, GPIO_PIN_RESET);

    // Rising/Hanging 캡처될 때까지 대기
    while (HCSR04_captureCnt < 2) { }

    // 펄스 폭 계산
    uint32_t width = (HCSR04_t2 >= HCSR04_t1) ? (HCSR04_t2 - HCSR04_t1) : (0xFFFF - HCSR04_t1 + HCSR04_t2 + 1);

    // cm 단위로 환산
    return width / HCSR04_CONV_FACTOR;
}

void HCSR04_IC_CaptureCallback(TIM_HandleTypeDef *htim)
{
    if (htim != hHCSR04Tim) return;

    if (HCSR04_captureCnt == 0)
    {
        // 상승 엣지
        HCSR04_t1 = HAL_TIM_ReadCapturedValue(hHCSR04Tim, HCSR04TimChannel);
        // 다음에 하강 엣지 캡처
        __HAL_TIM_SET_CAPTUREPOLARITY(hHCSR04Tim, HCSR04TimChannel,
                                      TIM_INPUTCHANNELPOLARITY_FALLING);
        HCSR04_captureCnt = 1;
    }
    else if (HCSR04_captureCnt == 1)
    {
        // 하강 엣지
        HCSR04_t2 = HAL_TIM_ReadCapturedValue(hHCSR04Tim, HCSR04TimChannel);
        // 다시 상승 엣지로 ㄱㄱ
        __HAL_TIM_SET_CAPTUREPOLARITY(hHCSR04Tim, HCSR04TimChannel,
                                      TIM_INPUTCHANNELPOLARITY_RISING);
        HCSR04_captureCnt = 2;
    }
}
