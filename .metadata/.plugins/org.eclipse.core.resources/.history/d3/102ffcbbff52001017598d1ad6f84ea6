/*
 * dht11.c
 *
 *  Created on: Jun 26, 2025
 *      Author: kccistc
 */



#include "dht11.h"

GPIO_TypeDef * dht11port;
uint32_t dht11pin;

void delay_us(uint32_t us)
{
    uint32_t cycles = (SystemCoreClock / 1000000) * us;
    uint32_t start = DWT->CYCCNT;
    while ((DWT->CYCCNT - start) < cycles);
}


void DHT11_Init(GPIO_TypeDef * port, uint16_t GPIO_Pin)
{
   dht11port = port;
   dht11pin = GPIO_Pin;
   Set_Pin_Output();
   HAL_GPIO_WritePin(dht11port, dht11pin, SET);
}

void Set_Pin_Output()
{
    GPIO_InitTypeDef GPIO_InitStruct = {0};
    GPIO_InitStruct.Pin = dht11pin;
    GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
    GPIO_InitStruct.Pull = GPIO_NOPULL;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
    HAL_GPIO_Init(dht11port, &GPIO_InitStruct);
}

void Set_Pin_Input()
{
    GPIO_InitTypeDef GPIO_InitStruct = {0};
    GPIO_InitStruct.Pin = dht11pin;
    GPIO_InitStruct.Mode = GPIO_MODE_AF_OD;
    GPIO_InitStruct.Pull = GPIO_NOPULL;
    GPIO_InitStruct.Alternate = GPIO_AF2_TIM4;            // TIM4 기능으로 설정
    HAL_GPIO_Init(dht11port, &GPIO_InitStruct);
}

void dht_start()
{   HAL_T0IM_IC_Stop_IT(&htim4, TIM_CHANNEL_1);
   __HAL_TIM_SET_COUNTER(&htim4, 0);
   HAL_GPIO_WritePin(dht11port, dht11pin, RESET);
   HAL_Delay(18);
   HAL_GPIO_WritePin(dht11port, dht11pin, SET);
   delay_us(30);
   Set_Pin_Input();
   delay_us(180);
   HAL_TIM_IC_Start_IT(&htim4, TIM_CHANNEL_1);
}

void DHT11_CaptureProcess(TIM_HandleTypeDef *htim)
{
      static uint8_t index = 0;
      static uint32_t data[40] = {0};
      static uint32_t rising_flag = 0;
      if(htim->Channel == HAL_TIM_ACTIVE_CHANNEL_1 && !rising_flag)
      {
         __HAL_TIM_SET_COUNTER(&htim4, 0);
         rising_flag = 1;
      }

      else if(htim->Channel == HAL_TIM_ACTIVE_CHANNEL_1 && rising_flag)
      {
         rising_flag = 0;
         if(HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_1) > 40)
            {
            data[index] = 1;
            }
         else {
            data[index] = 0;
         }
         index++;


      if (index < 40) {
          // 기록

      } else {
          // 수신 완료 처리
         index = 0;
          HAL_TIM_IC_Stop_IT(htim, TIM_CHANNEL_1);
          Set_Pin_Output();
          delay_us(30);
          HAL_GPIO_WritePin(dht11port, dht11pin, SET);
      }
      }

}
